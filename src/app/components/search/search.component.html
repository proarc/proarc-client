<div fxLayout="column" fxFlexFill>
  <div fxLayout="row" fxLayoutAlign="start center" class="app-breadcrumbsbar">
    <div fxLayout="row" fxLayoutAlign="start center" class="app-breadcrumbs">
      <a routerLink="/"><mat-icon>home</mat-icon> Home</a>
      <span class="app-separator">/</span>
      <span class="app-last">{{ 'search.title' | translate }}</span>
    </div>
    <button mat-button value="phrase"  [class.app-active]="searchMode === 'phrase'" (click)="searchMode = 'phrase'">Dotaz</button>
    <button mat-button value="advanced" [class.app-active]="searchMode === 'advanced'" (click)="searchMode = 'advanced'">Pokročilé hledání</button>
    <button mat-button value="deleted" [class.app-active]="searchMode === 'deleted'" (click)="searchMode = 'deleted'">Hledat ve smazaných</button>
  </div>

  <mat-progress-bar mode="indeterminate" *ngIf="state=='loading'" class="app-progress-bar"></mat-progress-bar>

  <div *ngIf="state!=='loading'" fxFlex class="app-search-results" fxLayout="column">
    <div class="app-formbar" fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start baseline">
      <button mat-flat-button color="primary" (click)="filter()">
        {{ 'search.search' | translate }}
      </button>
      <ng-container *ngIf="searchMode === 'phrase'">
        <mat-form-field>
          <mat-select #modelSelect [placeholder]="'search.model' | translate" name="model" [(ngModel)]="model" (keyup.enter)="enterModel(modelSelect)">
            <mat-option value="all">{{ 'search.all_models' | translate }}</mat-option>
            <mat-option *ngFor="let model of models" [value]="model">{{ "model." + model | translate }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field fxFlex>
          <input matInput [placeholder]="'search.search' | translate" (keyup.enter)="filter()" [(ngModel)]="query">
        </mat-form-field>
      </ng-container>
      <ng-container *ngIf="searchMode !== 'phrase'">
        <mat-form-field>
          <mat-select [placeholder]="'search.model' | translate" name="model" [(ngModel)]="model">
            <mat-option value="all">{{ 'search.all_models' | translate }}</mat-option>
            <mat-option *ngFor="let model of models" [value]="model">{{ "model." + model | translate }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field fxFlex>
          <input matInput [placeholder]="'search.fields.title' | translate" (keyup.enter)="filter()" [(ngModel)]="queryLabel">
        </mat-form-field>
        <mat-form-field fxFlex>
          <input matInput [placeholder]="'search.fields.identifier' | translate" (keyup.enter)="filter()" [(ngModel)]="queryIdentifier">
        </mat-form-field>
        <mat-form-field fxFlex>
          <input matInput [placeholder]="'search.fields.creator' | translate" (keyup.enter)="filter()" [(ngModel)]="queryCreator">
        </mat-form-field>
        <mat-form-field>
          <mat-select [placeholder]="'search.fields.organization' | translate" name="organization" [(value)]="organization">
            <mat-option value="-">Vše</mat-option>
            <mat-option *ngFor="let org of organizations" [value]="org">{{ 'organization.' + org | translate }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="app-owner">
          <mat-select [placeholder]="'search.fields.owner' | translate" name="owner" [(value)]="owner">
            <mat-option value="-">Vše</mat-option>
            <mat-option *ngFor="let user of users" [value]="user.name">{{ user.name }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="app-processor">
          <mat-select [placeholder]="'search.fields.processor' | translate" name="processor" [(value)]="processor">
            <mat-option value="-">Vše</mat-option>
            <mat-option *ngFor="let user of users" [value]="user.name">{{ user.name }}</mat-option>
          </mat-select>
        </mat-form-field>
      </ng-container>
    </div>
  
    <as-split fxFlex unit="percent" [gutterSize]="10" direction="vertical" (dragEnd)="dragEnd($event)" #split="asSplit">
      <as-split-area #area1="asSplitArea" [minSize]="20" [size]="getSplitSize(0)">
        <div class="app-content-wrapper" *ngIf="items" fxLayout="column" fxFlexFill>
          <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start center" class="app-toolbar app-toolbar-action app-view-border-bottom">
            <div fxFlex *ngIf="selectedItem" fxLayout="row" fxFlexFill>
              <button mat-icon-button [matMenuTriggerFor]="columns_menu" [matTooltip]="'editor.children.select_columns' | translate" >
                <mat-icon>rule</mat-icon>
              </button>
              <mat-menu #columns_menu="matMenu">
                <div *ngFor="let column of selectedColumns" mat-menu-item>
                  <mat-checkbox name="column.field" [(ngModel)]="column.selected" (change)="setSelectedColumns()">{{ 'search.' + column.field | translate }}</mat-checkbox>
                </div>
              </mat-menu>
              <button (click)="openItem(selectedItem)" mat-button>Otevřít</button>
              <button (click)="showFoxml(selectedItem)" mat-button>FOXML</button>
              <button (click)="onExport(selectedItem)" mat-button>Exportovat</button>
              <button (click)="onUrnnbn(selectedItem)" mat-button>URN:NBN</button>
              <button *ngIf="canChangeModel(selectedItem)" (click)="changeModel(selectedItem)" mat-button>Převody NDK modelů</button>
              <button (click)="onDeleteItem()" mat-button>Smazat</button>
              <button *ngIf="!selectedItem.isLocked && (auth.user.lockObjectFunction || auth.isSuperAdmin())" (click)="onLock(selectedItem, true)" mat-button>Uzamknout</button>
              <button *ngIf="selectedItem.isLocked && (auth.user.unlockObjectFunction || auth.isSuperAdmin())" (click)="onLock(selectedItem, false)" mat-button>Odemknout</button>
              <button *ngIf="selectedItem.state === 'fedora-system:def/model#Deleted'" (click)="onRestore(selectedItem)" mat-button>Obnovit objekt</button>
              <button (click)="updateObjects(selectedItem)" mat-button>Update všech objektů</button>
              
            </div>
            <div>
              <mat-paginator [length]="resultCount" hidePageSize="true" [pageIndex]="pageIndex" [pageSize]="pageSize" (page)="onPageChanged($event)"></mat-paginator>
            </div>
          </div>
          <div class="app-oa-y">
            <table mat-table #table [dataSource]="items" matSort class="app-striped app-hover" (matSortChange)="sortTable($event)">

              <ng-container matColumnDef="label">
                <th mat-header-cell *matHeaderCellDef mat-sort-header
                sortActionDescription="Sort by number">{{ 'desc.name' | translate }}</th>
                <td mat-cell *matCellDef="let element">
                  <div class="app-text-cutter-wrapper" [matTooltip]="element.label">
                    <div class="app-text-cutter">
                      {{ element.label }}
                    </div>
                  </div>
                </td>
              </ng-container>

              <ng-container matColumnDef="model">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.model' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ "model." + element.model | translate }}</td>
              </ng-container>

              <ng-container matColumnDef="pid">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.pid' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.pid }}</td>
              </ng-container>

              <ng-container matColumnDef="processor">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.processor' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.processor }}</td>
              </ng-container>

              <ng-container matColumnDef="organization">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.organization' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ 'organization.' + element.organization | translate }}</td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.status' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ 'editor.atm.statuses.' + element.status | translate }}</td>
              </ng-container>

              <ng-container matColumnDef="created">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.created' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.created | appDatetime }}</td>
              </ng-container>

              <ng-container matColumnDef="modified">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.modified' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.modified | appDatetime }}</td>
              </ng-container>

              <ng-container matColumnDef="owner">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ 'desc.owner' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.owner }}</td>
              </ng-container>

              <ng-container matColumnDef="export">
                <th mat-header-cell *matHeaderCellDef>{{ 'desc.export' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.writeExports() }}</td>
              </ng-container>

              <ng-container matColumnDef="isLocked">
                <th mat-header-cell *matHeaderCellDef></th>
                <td mat-cell *matCellDef="let element">
                  <mat-icon [matTooltip]="element.isLocked ? ('desc.locked' | translate) : ('desc.unlocked' | translate)">{{ element.isLocked ? 'lock' : 'lock_open' }}</mat-icon>
                </td>
              </ng-container>
    
              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selectItem(row)" (dblclick)="openItem(row)" class="app-cursor-pointer" [class.app-selected]="row == selectedItem"></tr>
            </table>
          </div>
        </div>
      </as-split-area>
      
      <as-split-area #area2="asSplitArea" [minSize]="20" [size]="getSplitSize(1)">
        <div class="app-content-wrapper" *ngIf="tree" fxLayout="column" fxFlexFill>
          <div fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start center" class="app-toolbar app-toolbar-action app-view-border-bottom">
            <div fxFlex *ngIf="search.selectedTree" fxLayout="row" fxFlexFill>
              <button (click)="selectItem(selectedItem)" mat-button>{{'common.refresh' | translate }}</button>
              <button (click)="openItem(search.selectedTree.item)" mat-button>Otevřít</button>
              <button (click)="showFoxml(search.selectedTree.item)" mat-button>FOXML</button>
              <button (click)="onExport(search.selectedTree.item)" mat-button>Exportovat</button>
              <button (click)="onUrnnbn(search.selectedTree.item)" mat-button>URN:NBN</button>
              <button *ngIf="canChangeModel(search.selectedTree.item)" (click)="changeModel(search.selectedTree.item)" mat-button>Převody NDK modelů</button>
              <button (click)="onExpandAll()" mat-button>Rozbalit</button>
              <button *ngIf="search.selectedTree.item" (click)="onDeleteFromTree()" mat-button>Smazat</button>
              <button *ngIf="canCopy(search.selectedTree.item)" (click)="onCopyItem(search.selectedTree.item)" mat-button>Zkopírovat</button>
              <button *ngIf="!search.selectedTree.item.isLocked && (auth.user.lockObjectFunction  || auth.isSuperAdmin())" (click)="onLock(search.selectedTree.item, true)" mat-button>Uzamknout</button>
              <button *ngIf="search.selectedTree.item.isLocked && (auth.user.unlockObjectFunction || auth.isSuperAdmin())" (click)="onLock(search.selectedTree.item, false)" mat-button>Odemknout</button>
              <button (click)="updateObjects(search.selectedTree.item)" mat-button>Update všech objektů</button>
            </div>
          </div>
          <div fxFlex class="app-table app-items app-oh">
            <div class="search-result-list">
              <div class="app-row app-header">
                <div class="result-label" *ngIf="properties.isSearchColEnabled('name')">
                  {{ 'search.name' | translate }}
                </div>
                <div class="result-model" *ngIf="properties.isSearchColEnabled('model')">
                  {{ 'search.model' | translate }}
                </div>
                <div class="result-pid" *ngIf="properties.isSearchColEnabled('pid')">
                  {{ 'search.pid' | translate }}
                </div>
                <div class="result-processor" *ngIf="properties.isSearchColEnabled('processor')">
                  {{ 'search.processor' | translate }}
                </div>
                <div class="result-organization" *ngIf="properties.isSearchColEnabled('organization')">
                  {{ 'search.organization' | translate }}
                </div>
                <div class="result-status" *ngIf="properties.isSearchColEnabled('status')">
                  {{ 'search.status' | translate }}
                </div>
                <div class="result-created" *ngIf="properties.isSearchColEnabled('created')">
                  {{ 'search.created' | translate }}
                </div>
                <div class="result-modified" *ngIf="properties.isSearchColEnabled('modified')">
                  {{ 'search.modified' | translate }}
                </div>
                <div class="result-owner" *ngIf="properties.isSearchColEnabled('owner')">
                  {{ 'search.owner' | translate }}
                </div>
                <div class="result-export" *ngIf="properties.isSearchColEnabled('export')">{{ 'search.export' | translate }}</div>
                <div class="result-export" *ngIf="properties.isSearchColEnabled('isLocked')">{{ 'search.isLocked' | translate }}</div>
              </div>
              <div class="scrollable">
                <app-tree [tree]="tree" (onOpen)="openFromTree($event)" (onSelect)="selectFromTree($event)"></app-tree>
              </div>
            </div>
          </div>
        </div>
      </as-split-area>
    </as-split>
  </div>
</div>