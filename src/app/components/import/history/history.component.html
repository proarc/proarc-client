<div fxLayout="column" fxFlexFill>
  <div fxLayout="row" fxLayoutAlign="start center" class="app-breadcrumbsbar">
    <div fxLayout="row" fxLayoutAlign="start center" class="app-breadcrumbs">
      <a routerLink="/"><mat-icon>home</mat-icon></a>
      <span class="app-separator">/</span>
      <a routerLink="/import">{{ 'desc.import' | translate }}</a>
      <span class="app-separator">/</span>
      <span class="app-last">{{ 'desc.batchManagement' | translate }}</span>
    </div>
  </div>

  <mat-progress-bar mode="indeterminate" *ngIf="state=='loading'"></mat-progress-bar>

  <div fxFlex class="app-history app-p-4" *ngIf="state=='success'" fxLayout="column">
    <div class="app-formbar" fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start baseline">
      <ng-container *ngIf="view == 'overview'">
        <mat-form-field>
          <mat-select [placeholder]="'desc.state' | translate" [(ngModel)]="selectedState" (selectionChange)="onStateChanged()">
            <mat-option *ngFor="let state of batchStates" [value]="state">{{ 'states.' + state | translate }}</mat-option>
          </mat-select>
        </mat-form-field>
        <button mat-flat-button color="primary" (click)="reload()">
          {{ 'button.refresh' | translate }}
        </button>
        <mat-checkbox [(ngModel)]="autoRefresh" (change)="setRefresh()">{{ 'desc.automaticallyRestore' | translate }}</mat-checkbox>
        <button mat-flat-button color="primary" (click)="changeView('loadingQueue')">
          {{ 'button.showLoadingQueue' | translate }}
        </button>
        <button mat-flat-button color="primary" (click)="onReloadBatch()" *ngIf="selectedBatch && (selectedBatch.state === 'LOADING_FAILED' || selectedBatch.state === 'LOADED' || selectedBatch.state === 'STOPPED')">
          {{ 'button.reload' | translate }}
        </button>
        <button mat-flat-button color="primary" (click)="onIngestBatch()" *ngIf="selectedBatch && selectedBatch.state === 'LOADED'">
          {{ 'button.continue' | translate }}
        </button>
        <button mat-flat-button color="primary" (click)="onEditBatchObject()" *ngIf="selectedBatch && selectedBatch.state === 'INGESTED' && selectedBatch.parentPid">
          {{ 'button.goToObject' | translate }}
        </button>
        <button mat-flat-button color="primary" (click)="onReexport()" *ngIf="selectedBatch && selectedBatch.state === 'EXPORT_FAILED'">
          {{ 'button.reexport' | translate }}
        </button>
      </ng-container>
      <ng-container *ngIf="view == 'loadingQueue'">
        <button mat-flat-button color="primary" (click)="reload()">
          <mat-icon>sync</mat-icon>
          {{ 'button.refresh' | translate }}
        </button>
        <button mat-flat-button color="primary" (click)="changeView('overview')">
          {{ 'button.backToTheListOfAllProcesses' | translate }}
        </button>
      </ng-container>
    </div>

    <div *ngIf="view == 'overview'" class="app-formbar" fxLayout="row" fxLayoutGap="16px" fxLayoutAlign="start baseline">
      <mat-form-field fxFlex>
        <input matInput [matTooltip]="'formField.folderNamePid.tooltip' | translate" [placeholder]="'formField.folderNamePid.placeholder' | translate" (keyup.enter)="filter()" [(ngModel)]="description">
      </mat-form-field>
      <mat-form-field class="app-resized">
        <input matInput [matDatepicker]="dp1" [placeholder]="'desc.createFrom' | translate" [(ngModel)]="createFrom" (keyup.enter)="filter()">
        <mat-datepicker-toggle matSuffix [for]="dp1"></mat-datepicker-toggle>
        <mat-datepicker #dp1></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="app-resized">
        <input matInput [matDatepicker]="dp2" [placeholder]="'desc.createTo' | translate" [(ngModel)]="createTo" (keyup.enter)="filter()">
        <mat-datepicker-toggle matSuffix [for]="dp2"></mat-datepicker-toggle>
        <mat-datepicker #dp2></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="app-resized">
        <input matInput [matDatepicker]="dp3" [placeholder]="'desc.modifiedFrom' | translate" [(ngModel)]="modifiedFrom" (keyup.enter)="filter()">
        <mat-datepicker-toggle matSuffix [for]="dp3"></mat-datepicker-toggle>
        <mat-datepicker #dp3></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="app-resized">
        <input matInput [matDatepicker]="dp4" [placeholder]="'desc.modifiedTo' | translate" [(ngModel)]="modifiedTo" (keyup.enter)="filter()">
        <mat-datepicker-toggle matSuffix [for]="dp4"></mat-datepicker-toggle>
        <mat-datepicker #dp4></mat-datepicker>
      </mat-form-field>
      <mat-form-field>
        <mat-select [placeholder]="'desc.user' | translate" name="user" [(ngModel)]="user" (keyup.enter)="filter()">
          <mat-option value="">{{ 'desc.all' | translate }}</mat-option>
          <mat-option *ngFor="let user of users" [value]="user.userId+''">{{ user.name }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="app-resized">
        <mat-select [placeholder]="'desc.priority' | translate" name="priority" [(value)]="priority" (keyup.enter)="filter()">
          <mat-option value="">{{ 'desc.all' | translate }}</mat-option>
          <mat-option *ngFor="let priority of priorities" [value]="priority">{{ 'formField.priorities.' + priority | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field>
        <mat-select [placeholder]="'desc.profile' | translate" name="profile" [(value)]="profile" (keyup.enter)="filter()">
          <mat-option value="">{{ 'desc.all' | translate }}</mat-option>
          <mat-option *ngFor="let profile of profiles" [value]="profile">{{ 'formField.profiles.' + profile | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="filter()" [matTooltip]="'button.filter' | translate">
        <mat-icon>filter_alt</mat-icon>
      </button>
    </div>

    <div fxFlex class="app-oa-y" *ngIf="view == 'overview'">
      <table mat-table #table [dataSource]="batches" class="app-striped app-hover">
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.folderNamePid' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.description }}</td>
        </ng-container>

        <ng-container matColumnDef="create">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.created' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.create | appDatetime }}</td>
        </ng-container>

        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.modified' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.timestamp | appDatetime }}</td>
        </ng-container>

        <ng-container matColumnDef="state">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.state' | translate }}</th>
          <td mat-cell *matCellDef="let element">
            <span class="app-badge" [ngClass]="batchProgress(element) === '0%' ? 'app-WAITING' : 'app-' + element.state">
              {{ batchProgress(element) === '0%' ? ('states.WAITING' | translate) : ('states.' + element.state | translate) }}<strong *ngIf="element.isLoading()" class="app-ml-2">{{ batchProgress(element) }}</strong>
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="profile">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.profile' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ 'formField.profiles.' +  element.profile | translate }}</td>
        </ng-container>

        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.user' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.user }}</td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.priority' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ 'formField.priorities.' + element.priority | translate }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <a *ngIf="element.failure" (click)="onShowLog(element);$event.preventDefault();$event.stopPropagation()" [matTooltip]="'button.viewErrorDetail' | translate" matTooltipPosition="below" class="app-icon-button">
              <mat-icon>error_outline</mat-icon>
            </a>
            <a *ngIf="element.state === 'INGESTING_FAILED'" (click)="reIngest(element);$event.preventDefault();$event.stopPropagation()" [matTooltip]="'button.saveAgain' | translate" matTooltipPosition="below" class="app-icon-button">
              <mat-icon>save_alt</mat-icon>
            </a>
            <a *ngIf="element.state === 'LOADING' && auth.isSuperAdmin()" (click)="stopBatch(element);$event.preventDefault();$event.stopPropagation()" [matTooltip]="'button.stop' | translate" matTooltipPosition="below" class="app-color-warn" class="app-icon-button">
              <mat-icon>cancel</mat-icon>
            </a>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsOverview; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsOverview;" class="app-cursor-pointer" [class.app-selected]="row == selectedBatch" (click)="selectBatch(row)" (dblclick)="openBatch(row)"></tr>
      </table>
      <mat-paginator [length]="resultCount" hidePageSize="true" [pageIndex]="pageIndex" [pageSize]="pageSize" (page)="onPageChanged($event)"></mat-paginator>
    </div>

    <div fxFlex class="app-oa-y app-mt-4" *ngIf="view == 'loadingQueue'">
      <table mat-table #table [dataSource]="queue" class="app-striped app-hover">
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.folderNamePid' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.description }}</td>
        </ng-container>

        <ng-container matColumnDef="create">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.created' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.create | appDatetime }}</td>
        </ng-container>

        <ng-container matColumnDef="timestamp">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.modified' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.timestamp | appDatetime }}</td>
        </ng-container>

        <ng-container matColumnDef="state">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.state' | translate }}</th>
          <td mat-cell *matCellDef="let element">
            <span class="app-badge" [ngClass]="batchProgress(element) === '0%' ? 'app-WAITING' : 'app-' + element.state">
              {{ batchProgress(element) === '0%' ? ('states.WAITING' | translate) : ('states.' + element.state | translate) }}<strong *ngIf="element.isLoading()" class="app-ml-2">{{ batchProgress(element) }}</strong>
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="pageCount">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.numberOfPages' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.pageCount }}</td>
        </ng-container>

        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>{{ 'desc.user' | translate }}</th>
          <td mat-cell *matCellDef="let element">{{ element.user }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsQueue; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsQueue;" class="app-cursor-pointer" [class.app-selected]="row == selectedBatch" (click)="selectBatch(row)" (dblclick)="openBatch(row)"></tr>
      </table>
    </div>
  </div>
</div>
