@if (loading) {
  <mat-progress-bar mode="indeterminate" class="app-progress-bar"></mat-progress-bar>
}
@if (!loading) {
  <div class="app-fxLayout app-column app-fill app-editor-wrapper">
    <div class="app-fxLayout app-r	ow app-center-v app-gap-4 app-breadcrumbsbar">
      <div class="app-fxLayout app-row app-center-v app-inner">
        <a routerLink="/"><mat-icon>home</mat-icon></a>
        <span class="app-separator">/</span>
        <a class="app-text-cutter" routerLink="/workflow/jobs">{{ 'navbar.workflow' | translate }}</a>
        <span class="app-separator">/</span>
        <span class="app-text-cutter">{{ (onlyMyTasks ? 'navbar.my_tasks' : 'navbar.tasks') | translate }}</span>
      </div>
    </div>
    <div class="app-fxFlex app-oh app-content-wrapper">
      <div class="app-border-wrapper app-h-100">
        <as-split direction="horizontal">
          <as-split-area [size]="40">
            <div class="app-fxLayout app-column app-fill">
              @if (!id) {
                <div class="app-fxLayout app-row app-toolbar">
                  <div class="app-fxFlex app-fxLayout app-row app-center-v">
                    <button (click)="getTasks()" mat-icon-button [matTooltip]="'button.refresh' | translate"><mat-icon>sync</mat-icon></button>
                    @if (this.totalSelected > 1) {
                      <button mat-button (click)="editTasks()" >{{'workflow.multipleJobsEdit' | translate}}</button>
                    }
                  </div>
                  <div>
                    <button mat-icon-button [matMenuTriggerFor]="menuMoreTasks" [matTooltip]="'button.more' | translate"><mat-icon>more_vert</mat-icon></button>
                    <mat-menu #menuMoreTasks="matMenu">
                      <!-- <button mat-menu-item (click)="selectColumns('tasks')" >{{'editor.children.select_columns' | translate}}</button> -->
                    </mat-menu>
                  </div>
                </div>
              }
              <div class="app-fxFlex app-oa-y">
                <div class="app-editor-content">
                  <app-user-table (sortBy)="sortTasksTable($event)" (selectItem)="taskClick($event)" [colsSettingsName]="'columnsWorkFlowTasks'" [items]="tasks" ></app-user-table>
                </div>
              </div>
            </div>
          </as-split-area>
          <as-split-area [size]="60">
            <as-split direction="vertical">
              <as-split-area>
                <div class="app-fxLayout app-column app-fill">
                  @if (totalSelected === 1) {
                    <div class="app-fxLayout app-row app-toolbar">
                      <div class="app-fxFlex app-fxLayout app-row app-center-v">
                        <button  (click)="getTask(task.id)" mat-button>{{'common.refresh' | translate }}</button>
                        <button  (click)="gotoJob(task.jobId)" mat-button>{{'workflow.job' | translate }}</button>
                        <button (click)="saveTask()" mat-button>{{'common.save' | translate }}</button>
                      </div>
                    </div>
                  }
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-container">
                      <div class="app-gap-fixer"></div>
                      @if (task && totalSelected === 1) {
                        <div class="app-form-wrapper app-top-level">
                          <h3 class="app-mb-2 app-ml-2 app-mr-2">{{ task.jobLabel }}</h3>
                          <div class="app-form">
                            <div class="app-form-content">
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.state' | translate }}</mat-label>
                                <mat-select [(ngModel)]="task.state" [placeholder]="'desc.state' | translate">
                                  @for(o of states; track $index;) {
                                    <mat-option [value]="o.code">{{o.value}}</mat-option>
                                  }
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.priority' | translate }}</mat-label>
                                <mat-select [(ngModel)]="task.priority" [placeholder]="task.priority">
                                  @for(o of priorities; track $index;) {
                                    <mat-option [value]="o.code">{{o.value}}</mat-option>
                                  }
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.user' | translate }}</mat-label>
                                <mat-select [(ngModel)]="task.ownerId" [placeholder]="task.ownerName">
                                  @for(s of users; track $index;) {
                                    <mat-option [value]="s.userId">{{ s.name }}</mat-option>
                                  }
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'workflow.task' | translate }}</mat-label>
                                <input matInput disabled readonly="true" [value]="task.profileLabel">
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.created' | translate }}</mat-label>
                                <input matInput disabled readonly="true" [value]="task.created | date : 'dd.MM.yyyy HH:mm'">
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.modified' | translate }}</mat-label>
                                <input matInput disabled readonly="true" [value]="task.modified | date : 'dd.MM.yyyy HH:mm'">
                              </mat-form-field>
                              <mat-form-field  class="app-field-col">
                                <mat-label>{{ 'desc.note' | translate }}</mat-label>
                                <textarea [(ngModel)]="task.note" matInput [placeholder]="'desc.note' | translate"></textarea>
                              </mat-form-field>
                              @for(param of parameters; track $index;) {
                                @switch (param.displayType) {
                                  @case ('TEXT') {
                                    <mat-form-field  class="app-field-col">
                                      <mat-label>{{ param.profileLabel }}</mat-label>
                                      <input matInput [(ngModel)]="param.value" [id]="'param_' + param.profileName" [type]="param.valueType.toLowerCase()" [required]="param.required">
                                    </mat-form-field>
                                  }
                                  @case ('CHECKBOX') {
                                    <div class="app-mb-2">
                                      <mat-checkbox color="primary" [(ngModel)]="param.value">{{ param.profileHint}}</mat-checkbox>
                                    </div>
                                  }
                                  @case ('COMBOBOX') {
                                    <mat-form-field  class="app-field-col">
                                      <mat-label>{{ param.profileLabel }}</mat-label>
                                      <mat-select [(ngModel)]="param.value">
                                        @for(o of getValueMap(param.valueMapId); track $index;) {
                                          <mat-option [value]="o.value">{{o.value}}</mat-option>
                                        }
                                      </mat-select>
                                    </mat-form-field>
                                  }
                                  @default {
                                    <div>{{ param.displayType }}</div>
                                  }
                                }
                              }
                            </div>
                          </div>
                          <div class="app-gap-fixer"></div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </as-split-area>
              <as-split-area>
                <div class="app-fxLayout app-column app-fill">
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-content">
                      <table mat-table [dataSource]="material" multiTemplateDataRows class="app-expanded app-hover">
                        @for(column of materialColumnsToDisplay; track $index;) {
                          <ng-container matColumnDef="{{column}}" >
                            <th mat-header-cell *matHeaderCellDef>{{ 'dynamic.workFlow.' + column | translate }}</th>
                            <td mat-cell *matCellDef="let element">{{ element[column] }}</td>
                          </ng-container>
                        }
                        <ng-container matColumnDef="expand">
                          <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
                          <td mat-cell *matCellDef="let element" class="app-pr-0">
                            <div class="app-fxLayout app-row app-jc-end">
                              <button mat-icon-button (click)="(materialExpandedElement = materialExpandedElement === element ? null : element); $event.stopPropagation()" class="app-toggle-button" [class.app-toggle-button-expanded]="materialExpandedElement === element">
                                <mat-icon>keyboard_arrow_down</mat-icon>
                              </button>
                            </div>
                          </td>
                        </ng-container>
                        <ng-container matColumnDef="expandedDetail">
                          <td mat-cell *matCellDef="let element" [attr.colspan]="materialColumnsToDisplayWithExpand.length" class="app-p-0">
                            <div class="app-detail" [@detailExpand]="element == materialExpandedElement ? 'expanded' : 'collapsed'">
                              <app-material-edit [material]="element"></app-material-edit>
                            </div>
                          </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="materialColumnsToDisplayWithExpand; sticky: true"></tr>
                        <tr mat-row *matRowDef="let element; columns: materialColumnsToDisplayWithExpand;" [class.app-row-expanded-parent]="materialExpandedElement === element" (click)="materialExpandedElement = materialExpandedElement === element ? null : element"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="app-row-detail" [class.app-row-expanded]="materialExpandedElement === row"></tr>
                      </table>
                    </div>
                  </div>
                </div>
              </as-split-area>
            </as-split>
          </as-split-area>
        </as-split>
      </div>
    </div>
  </div>
}