@if (loading) {
  <mat-progress-bar mode="indeterminate" class="app-progress-bar"></mat-progress-bar>
}
@if (!loading) {
  <div class="app-fxLayout app-column app-fill app-editor-wrapper">
    <div class="app-fxLayout app-row app-center-v app-gap-4 app-breadcrumbsbar">
      <div class="app-fxLayout app-row app-center-v app-inner">
        <a routerLink="/"><mat-icon>home</mat-icon></a>
        <span class="app-separator">/</span>
        <a routerLink="/workflow">{{ 'navbar.workflow' | translate }}</a>
      </div>
    </div>
    <div class="app-fxFlex app-oh app-content-wrapper">
      <div class="app-border-wrapper app-h-100">
        <as-split direction="horizontal">
          <as-split-area [size]="40">
            <as-split direction="vertical">
              <!-- Zamery -->
              <as-split-area>
                <div class="app-fxLayout app-column app-fill">
                  <div class="app-fxLayout app-row app-toolbar">
                    <div class="app-fxFlex app-fxLayout app-row app-center-v">
                      <button (click)="getWorkflow(false)" mat-icon-button [matTooltip]="'button.refresh' | translate"><mat-icon>sync</mat-icon></button>
                      @if (selectedProfile && selectedProfile.subjob.length > 0) {
                        <button mat-button (click)="createSubJob(selectedJob)">{{ "workflow.create_new_subjob" | translate }}</button>
                      }
                      <button (click)="createJob(profiles, profiles[0], -1)" mat-button>{{'workflow.create_new' | translate }}</button>
                      @if (selectedProfile) {
                        <button mat-button [disabled]="hasObject" [matMenuTriggerFor]="object_menu">{{ "workflow.create_new_object" | translate }}</button>
                        <mat-menu #object_menu="matMenu">
                          @for(model of selectedProfile.model; track $index;) {
                            <button mat-menu-item (click)="createNewObject(model.name)">{{ 'model.' + model.name | translate}}</button>
                          }
                        </mat-menu>
                      }
                    </div>
                    <div>
                      <button mat-icon-button [matMenuTriggerFor]="menuMore" [matTooltip]="'button.more' | translate">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <mat-menu #menuMore="matMenu">
                        @if (auth.user.wfDeleteJobFunction || auth.isSuperAdmin()) {
                          <button mat-menu-item (click)="removeJobs(false)" >{{'workflow.remove_job' | translate}}</button>
                        }
                        @if (this.totalSelected > 1) {
                          <button mat-menu-item (click)="editJobs()" >{{'workflow.multipleJobsEdit' | translate}}</button>
                        }
                        @if (hasMetadata) {
                          <button mat-menu-item (click)="editMetadata()" >{{'button.editMetadata' | translate}}</button>
                        }
                      </mat-menu>
                    </div>
                  </div>
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-content">
                      <app-user-table [withFilters]="true" (sortBy)="sortJobsTable($event)" (selectItem)="jobClick($event)" (onFilter)="filter($event)" [colsSettingsName]="'columnsWorkFlow'" [items]="jobs" ></app-user-table>
                    </div>
                  </div>
                </div>
              </as-split-area>
              <!-- Podzamery -->
              <as-split-area>
                @if (selectedJob) {
                  <div class="app-fxLayout app-column app-fill">
                    @if (visibleSubJobs.length === 0) {
                      <mat-card appearance="outlined" class="app-alert app-info">
                        <mat-card-content>
                          <mat-icon>info</mat-icon>{{ 'alert.info.noItemsToDisplay' | translate }}
                        </mat-card-content>
                      </mat-card>
                    }
                    <div class="app-fxLayout app-column app-fill">
                      @if (subJobs.length > 0) {
                        <div class="app-fxLayout app-row app-toolbar">
                          <div class="app-fxFlex app-fxLayout app-row app-center-v">
                            <button (click)="refreshSubJobs()" mat-icon-button [matTooltip]="'button.refresh' | translate"><mat-icon>sync</mat-icon></button>
                            @if (selectedSubJob?.expandable) {
                              <button mat-button (click)="createSubJob(selectedSubJob)">{{ "workflow.create_new_subjob" | translate }}</button>
                            }
                            @if (selectedSubJobProfile) {
                              <button mat-button [disabled]="hasObject" [matMenuTriggerFor]="object_menu">{{ "workflow.create_new_object" | translate }}</button>
                              <mat-menu #object_menu="matMenu">
                                @for(model of selectedSubJobProfile.model; track $index;) {
                                  <button mat-menu-item (click)="createNewObject(model.name)">{{ 'model.' + model.name | translate}}</button>
                                }
                              </mat-menu>
                            }
                          </div>
                          <div>
                            <button mat-icon-button [matMenuTriggerFor]="menuMore" [matTooltip]="'button.more' | translate">
                              <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #menuMore="matMenu">
                              @if (auth.user.wfDeleteJobFunction || auth.isSuperAdmin()) {
                                <button mat-menu-item (click)="removeJobs(true)" >{{'workflow.remove_job' | translate}}</button>
                              }
                            </mat-menu>
                          </div>
                        </div>
                      }
                      <div class="app-fxFlex app-oa-y">
                        <div class="app-editor-content">
                          <app-user-tree-table #treeTable [type]="'TreeWorkFlow'" [inSearch]="false" [treePath]="[selectedJob.id + '']" [rootTreeItem]="selectedJob" (onSelectTreeItem)="selectSubJob($event)" (onTreeItemsChanged)="visibleSubJobs = $event"></app-user-tree-table>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </as-split-area>
            </as-split>
          </as-split-area>
          <as-split-area [size]="60">
            <as-split direction="vertical">
              <as-split-area [size]="30">
                <div class="app-fxLayout app-column app-fill">
                  <div class="app-fxLayout app-row app-toolbar">
                    <div class="app-fxFlex app-fxLayout app-row app-center-v">
                      <button (click)="getDetail()" mat-icon-button [matTooltip]="'button.refresh' | translate"><mat-icon>sync</mat-icon></button>
                      <button (click)="saveDetail()" mat-button>{{'button.save' | translate }}</button>
                    </div>
                  </div>
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-container">
                      <div class="app-gap-fixer"></div>
                      @if (activeJob) {
                        <div class="app-form-wrapper app-top-level">
                          <div class="app-form">
                            <div class="app-form-content">
                              <mat-form-field  class="app-field-col">
                                <mat-label>{{ 'desc.name' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'desc.name' | translate" [(ngModel)]="activeJob.label">
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.state' | translate }}</mat-label>
                                <mat-select [(ngModel)]="activeJob.state" [placeholder]="'desc.state' | translate">
                                  @for(o of states; track $index;) {
                                    <mat-option [value]="o.code">{{o.value}}</mat-option>
                                  }
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.priority' | translate }}</mat-label>
                                <mat-select [(ngModel)]="activeJob.priority" [placeholder]="'desc.priority' | translate">
                                  @for(o of priorities; track $index;) {
                                    <mat-option [value]="o.code">{{o.value}}</mat-option>
                                  }
                                </mat-select>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.profile' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'desc.profile' | translate" [(ngModel)]="activeJob.profileName" readonly>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.owner' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'desc.owner' | translate" [(ngModel)]="activeJob.ownerName" readonly>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'desc.financed' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'desc.financed' | translate" [(ngModel)]="activeJob.financed">
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-3">
                                <mat-label>{{ 'id' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'id' | translate" [(ngModel)]="activeJob.id" readonly>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-2">
                                <mat-label>{{ 'desc.created' | translate }}</mat-label>
                                <input matInput [placeholder]="'desc.created' | translate" [value]="activeJob.created | date : 'dd.MM.yyyy HH:mm'" readonly>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col app-field-col-2">
                                <mat-label>{{ 'desc.modified' | translate }}</mat-label>
                                <input autocomplete="off" matInput [placeholder]="'desc.modified' | translate" [value]="activeJob.modified | date : 'dd.MM.yyyy HH:mm'" readonly>
                              </mat-form-field>
                              <mat-form-field  class="app-field-col">
                                <mat-label>{{ 'desc.note' | translate }}</mat-label>
                                <textarea [(ngModel)]="activeJob.note" matInput [placeholder]="'desc.note' | translate"></textarea>
                              </mat-form-field>
                            </div>
                          </div>
                          <div class="app-gap-fixer"></div>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </as-split-area>
              <as-split-area [size]="40">
                <div class="app-fxLayout app-column app-fill">
                  <div class="app-fxLayout app-row app-toolbar">
                    <div class="app-fxFlex app-fxLayout app-row app-center-v">
                      <button mat-button [matMenuTriggerFor]="menuAddStep" [matTooltip]="'workflow.add_step' | translate">
                        {{ 'workflow.add_step' | translate }}
                      </button>
                      <mat-menu #menuAddStep="matMenu">
                        @for(profile of selectedProfile.task; track $index;) {
                          <button mat-menu-item (click)="addStep(profile.name)" >{{ profile.title }}</button>
                        }
                      </mat-menu>
                    </div>
                  </div>
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-content">
                      <app-user-table (sortBy)="sortTasksTable($event)" (selectItem)="openTask($event)" [colsSettingsName]="'columnsWorkFlowTasks'" [items]="tasks" ></app-user-table>
                    </div>
                  </div>
                </div>
              </as-split-area>
              <as-split-area>
                <div class="app-fxLayout app-column app-fill">
                  <div class="app-fxFlex app-oa-y">
                    <div class="app-editor-content">
                      <table mat-table [dataSource]="materials" multiTemplateDataRows class="app-expanded app-hover">
                        @for(column of materialColumnsToDisplay; track $index;) {
                          <ng-container matColumnDef="{{column}}" >
                            <th mat-header-cell *matHeaderCellDef>{{ 'dynamic.workFlow.' + column | translate }}</th>
                            <td mat-cell *matCellDef="let element" class="app-text-cutter">
                              @if (column === 'label' && element['type'] === 'DIGITAL_OBJECT') {
                                <a class="app-icon-copy app-mr-1" (click)="copyTextToClipboard(element.pid)" [matTooltip]="'button.copyTextToClipboard' | translate"><mat-icon class="app-icon-copy">content_copy</mat-icon></a>
                              }
                              {{ element[column] }}
                            </td>
                          </ng-container>
                        }
                        <ng-container matColumnDef="expand">
                          <th mat-header-cell *matHeaderCellDef aria-label="row actions">&nbsp;</th>
                          <td mat-cell *matCellDef="let element" class="app-pr-0">
                            <div class="app-fxLayout app-row app-jc-end">
                              <button mat-icon-button (click)="(materialExpandedElement = materialExpandedElement === element ? null : element); $event.stopPropagation()" class="app-toggle-button" [class.app-toggle-button-expanded]="materialExpandedElement === element">
                                <mat-icon>keyboard_arrow_down</mat-icon>
                              </button>
                            </div>
                          </td>
                        </ng-container>
                        <ng-container matColumnDef="expandedDetail">
                          <td mat-cell *matCellDef="let element" [attr.colspan]="materialColumnsToDisplayWithExpand.length" class="app-p-0">
                            <div class="app-detail" [@detailExpand]="element == materialExpandedElement ? 'expanded' : 'collapsed'">
                              <app-material-edit [material]="element" [workflow]="activeJob" (onRefresh)="getWorkflow(true)"></app-material-edit>
                            </div>
                          </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="materialColumnsToDisplayWithExpand; sticky: true"></tr>
                        <tr mat-row *matRowDef="let element; columns: materialColumnsToDisplayWithExpand;" [class.app-row-expanded-parent]="materialExpandedElement === element" (click)="materialExpandedElement = materialExpandedElement === element ? null : element"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="app-row-detail" [class.app-row-expanded]="materialExpandedElement === row"></tr>
                      </table>
                    </div>
                  </div>
                </div>
              </as-split-area>
            </as-split>
          </as-split-area>
        </as-split>
      </div>
    </div>
  </div>
}

